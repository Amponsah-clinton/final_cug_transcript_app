{% extends "base.html" %}
{% block content %}

<div class="container py-5">
  <div class="text-center mb-4">
    <h2 class="fw-bold text-primary">Welcome, {{student.name|capfirst }} </h2>
    <p class="text-muted mb-0">Logged in as <strong>{{ user.email }}</strong></p>
  </div>

 <style>
.custom-alert {
  position: relative;
  width: 100%;
  max-width: 600px;
  margin: 0 auto 1.5rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 1.5rem;
  border-radius: 10px;
  font-weight: 500;
  transition: all 0.4s ease;
  border: 1px solid;
}

.custom-alert svg {
  flex-shrink: 0;
  margin-right: 0.6rem;
}

.custom-alert button {
  position: absolute;
  right: 1rem;
  top: 1rem;
  background: transparent;
  border: 1px solid;
  border-radius: 6px;
  padding: 4px;
  opacity: 0.5;
  transition: all 0.3s ease;
  cursor: pointer;
}

.custom-alert button:hover {
  opacity: 1;
}

.alert-info {
  background: linear-gradient(#e3f2fd, #e3f2fd);
  border-color: #0d6efd;
  color: #0d6efd;
}

.alert-primary {
  background: linear-gradient(#e8eafc, #e8eafc);
  border-color: #6f42c1;
  color: #6f42c1;
}

.alert-success {
  background: linear-gradient(#e9f9ee, #e9f9ee);
  border-color: #198754;
  color: #198754;
}

.alert-warning {
  background: linear-gradient(#fff4e5, #fff4e5);
  border-color: #ffc107;
  color: #b58900;
}

.alert-danger {
  background: linear-gradient(#fde8e8, #fde8e8);
  border-color: #dc3545;
  color: #b22b2b;
}
</style>

<div class="container">
  {% if requests %}
    {% with req=requests.0 %}
      {% if req.fee_clearance %}
        {% if req.fee_clearance.cleared and not req.fee_clearance.owes %}
          {% if req.selections.exists %}
            {% with batch=req.selections.first.batch %}
              {% if batch.status == 'pending' %}
                <div class="custom-alert alert-info">
                  <p class="m-0 d-flex align-items-center">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="12" r="10"></circle>
                      <path d="M12 6v6l4 2"></path>
                    </svg>
                    Your transcript ({{ req.reference_code }}) is being reviewed by the Registrar.
                  </p>
                  <button type="button" onclick="this.parentElement.remove()">
                    ✕
                  </button>
                </div>

              {% elif batch.status == 'under_review' %}
                <div class="custom-alert alert-primary">
                  <p class="m-0 d-flex align-items-center">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="12" r="10"></circle>
                      <path d="M12 8v4l3 2"></path>
                    </svg>
                    Your transcript ({{ req.reference_code }}) is currently under review.
                  </p>
                  <button type="button" onclick="this.parentElement.remove()">✕</button>
                </div>

              {% elif batch.status == 'approved' %}
                <div class="custom-alert alert-success">
                  <p class="m-0 d-flex align-items-center">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Your transcript ({{ req.reference_code }}) has been approved!
                    <a href="{% url 'approved_transcripts' %}" class="ms-2 text-success fw-bold">
                      <i class="fas fa-download"></i> Download
                    </a>
                  </p>
                  <button type="button" onclick="this.parentElement.remove()">✕</button>
                </div>

              {% elif batch.status == 'rejected' %}
                <div class="custom-alert alert-danger">
                  <p class="m-0 d-flex align-items-center">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    Your transcript ({{ req.reference_code }}) was rejected.
                  </p>
                  <button type="button" onclick="this.parentElement.remove()">✕</button>
                </div>
              {% endif %}
            {% endwith %}
          {% else %}
            <div class="custom-alert alert-success">
              <p class="m-0 d-flex align-items-center">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                Request {{ req.reference_code }} cleared by Accounts. Proceeding to Exams Office.
              </p>
              <button type="button" onclick="this.parentElement.remove()">✕</button>
            </div>
          {% endif %}
        {% else %}
          <div class="custom-alert alert-warning">
            <p class="m-0 d-flex align-items-center">
              <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
              </svg>
              Accounts Review: You owe
              {% if req.fee_clearance.amount_owed %}
              <strong>GHS {{ req.fee_clearance.amount_owed }}</strong>
              {% endif %}. Please settle fees.
            </p>
            <button type="button" onclick="this.parentElement.remove()">✕</button>
          </div>
        {% endif %}
      {% endif %}
    {% endwith %}
  {% endif %}
</div>


<style>
  body {
    background: #f8fafc;
    font-family: "Poppins", sans-serif;
  }

  .profile-card {
    background: #fff;
    border-radius: 25px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    padding: 2rem;
    max-width: 420px;
    margin: 40px auto;
    text-align: center;
    position: relative;
    overflow: hidden;
    transition: all 0.4s ease;
  }

  .profile-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 16px 40px rgba(0, 0, 0, 0.1);
  }

  /* Subtle glowing border */
  .profile-card::before {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: 25px;
    border: 1px solid rgba(99, 102, 241, 0.2);
    opacity: 0;
    transition: 0.4s ease;
  }

  .profile-card:hover::before {
    opacity: 1;
  }

  .profile-card img {
    width: 110px;
    height: 110px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 15px;
    box-shadow: 0 0 0 4px #fff, 0 4px 10px rgba(0, 0, 0, 0.15);
    transition: 0.4s ease;
  }

  .profile-card:hover img {
    transform: scale(1.05);
  }

  .profile-card h4 {
    font-weight: 600;
    color: #111827;
    margin-bottom: 6px;
  }

  .profile-card p {
    color: #6b7280;
    margin-bottom: 15px;
    font-size: 14px;
  }

  .profile-table {
    width: 100%;
    margin-top: 1rem;
    font-size: 14px;
    border-collapse: separate;
    border-spacing: 0 5px;
  }

  .profile-table th {
    text-align: left;
    color: #6b7280;
    font-weight: 500;
    width: 45%;
  }

  .profile-table td {
    text-align: right;
    color: #374151;
    font-weight: 500;
  }

  .profile-alert {
    background: #fff8e1;
    color: #a16207;
    border-radius: 10px;
    padding: 10px;
    font-size: 13px;
    margin-top: 10px;
  }

  /* Animated status indicator */
  .status-dot {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #10b981;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.6); }
    70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
    100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
  }

  /* Buttons */
  .profile-actions {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 20px;
  }

  .action-btn {
    background: #f3f4f6;
    border: none;
    border-radius: 50%;
    width: 42px;
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    color: #4f46e5;
  }

  .action-btn:hover {
    background: #eef2ff;
    transform: scale(1.1);
  }

  @media (max-width: 480px) {
    .profile-card {
      padding: 1.5rem;
    }

    .profile-table th,
    .profile-table td {
      font-size: 13px;
    }
  }
</style>

<div class="profile-card">
  <div class="status-dot"></div>

<style>
.profile-pic {
  width: 130px;
  height: 130px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid #fff;
  box-shadow: 
    0 0 15px rgba(255, 215, 0, 0.6),
    0 0 30px rgba(255, 215, 0, 0.4),
    0 0 45px rgba(255, 215, 0, 0.2);
  transition: transform 0.3s ease;
}
</style>

{% if profile.profile_image %}
  <img src="{{ profile.profile_image.url }}" alt="Profile Picture" class="profile-pic">
{% else %}
  <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Default Avatar" class="profile-pic">
{% endif %}



  <h4>{{ user.username|capfirst }}</h4>
  <p>Your Student Dashboard</p>

  {% if profile %}
    <table class="profile-table">
      <tr><th>Index Number</th><td>{{ profile.index_number }}</td></tr>
      <tr><th>Phone</th><td>{{ profile.phone_number }}</td></tr>
      {% if student %}
        <tr><th>Name</th><td>{{ student.name }}</td></tr>
        <tr><th>Email</th><td>{{ user.email }}</td></tr>
        <tr><th>Program</th><td>{{ student.program.name }}</td></tr>
        <tr><th>Department</th><td>{{ student.department.department }}</td></tr>
      {% else %}
        <tr><td colspan="2" class="text-muted text-center">Not linked to student record.</td></tr>
      {% endif %}
    </table>

  
  {% else %}
    <div class="profile-alert">
      Your profile hasn’t been linked. Contact the administrator.
    </div>
  {% endif %}
</div>
  <!-- Transcript Requests -->
 {% if requests_data %}
<div class="card shadow-sm border-0 rounded-4 mb-5 overflow-hidden">
  <div class="card-header bg-gradient bg-primary text-white py-3">
    <h5 class="fw-bold mb-0 text-center">
      <i class="fas fa-file-alt me-2"></i>Your Transcript Requests
    </h5>
  </div>

  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0 text-center">
        <thead class="table-light border-bottom">
          <tr class="text-primary small text-uppercase">
            <th>#</th>
            <th>Transcript Type</th>
            <th>Reference</th>
            <th>Date Requested</th>
            <th>Payment</th>
            <th>Status</th>
            <th>Download</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
          {% for item in requests_data %}
          {% with req=item.request %}
          <tr>
            <td class="fw-semibold text-muted">{{ forloop.counter }}</td>
            <td>{{ req.get_transcript_type_display }}</td>
            <td><code class="text-primary fw-semibold">{{ req.reference_code }}</code></td>
            <td>{{ req.date_requested|date:"M d, Y h:i A" }}</td>

            <td class="text-start align-middle">
              {% if req.transcript_type == 'unofficial' %}
                <div>
                  <span class="badge rounded-pill bg-success px-3 py-1">Paid &amp; Cleared</span>
                  <div class="small text-muted mt-1">Unofficial transcripts are processed without fee holds.</div>
                </div>
              {% elif item.payment_badge == "warning" %}
                <div>
                  <span style="color: white !important;" class="badge rounded-pill bg-danger text-dark px-3 py-1">{{ item.payment_label }}</span>
                  {% if item.request.fee_clearance and item.request.fee_clearance.amount_owed %}
                    <!-- <div class="small fw-semibold mt-1">Due: GHS {{ item.request.fee_clearance.amount_owed }}</div> -->
                  {% endif %}
                  <div class="d-flex flex-wrap gap-1 mt-2">
                    <a href="{% url 'download_invoice' item.request.id %}" class="btn btn-outline-primary btn-sm d-flex align-items-center">
                      <i class="fas fa-file-invoice me-1 small"></i>Invoice
                    </a>
                    <a href="{% url 'notify_payment_made' item.request.id %}" class="btn btn-success btn-sm d-flex align-items-center">
                      <i class="fas fa-bell me-1 small"></i>Notify
                    </a>
                  </div>
                </div>
              {% elif item.payment_badge == "info" %}
                <div>
                  <span class="badge rounded-pill bg-info text-dark px-3 py-1">{{ item.payment_label }}</span>
                  <div class="small text-muted mt-1">Payment received — pending Accounts verification.</div>
                </div>
              {% elif item.payment_badge == "success" %}
                <div>
                  <span class="badge rounded-pill bg-success px-3 py-1">{{ item.payment_label }}</span>
                  <div class="small text-muted mt-1">Verified — now processing.</div>
                </div>
              {% elif item.payment_badge == "secondary" %}
                <div>
                  <span class="badge rounded-pill bg-secondary px-3 py-1">{{ item.payment_label }}</span>
                  <div class="small text-muted mt-1">Under review.</div>
                </div>
              {% else %}
                <div>
                  <span class="badge rounded-pill bg-light text-muted px-3 py-1">{{ item.payment_label }}</span>
                </div>
              {% endif %}
            </td>

            <td>
              {% if item.processing_badge == "danger" %}
                <div class="d-flex flex-column align-items-center gap-1">
                  <span class="badge rounded-pill bg-danger px-3 py-1">
                    {{ item.processing_label }}
                  </span>

                  {% if item.latest_status and item.latest_status.remarks %}
                    <button class="btn btn-outline-danger btn-xs" data-bs-toggle="modal"
                            data-bs-target="#remarksModal{{ req.id }}">
                      <i class="fas fa-eye me-1 small"></i>View Details
                    </button>
                  {% endif %}
                </div>
              {% elif item.processing_badge == "warning" %}
                <span class="badge rounded-pill bg-warning text-dark px-3 py-1">{{ item.processing_label }}</span>
              {% elif item.processing_badge == "primary" %}
                <span class="badge rounded-pill bg-primary px-3 py-1">{{ item.processing_label }}</span>
              {% elif item.processing_badge == "success" %}
                <span class="badge rounded-pill bg-success px-3 py-1">{{ item.processing_label }}</span>
              {% elif item.processing_badge == "secondary" %}
                <span class="badge rounded-pill bg-secondary px-3 py-1">{{ item.processing_label }}</span>
              {% else %}
                <span class="badge rounded-pill bg-dark text-white px-3 py-1">{{ item.processing_label }}</span>
              {% endif %}
            </td>

       <td>
  {% if item.download_ready %}
    <a href="{% url 'student_download_transcript' item.request.id %}"
       class="btn btn-xs btn-outline-success d-flex align-items-center justify-content-center">
      <i class="fas fa-download me-1 small"></i>Download
    </a>
  {% else %}
    <span class="text-muted small">Not Ready</span>
  {% endif %}
</td>

            <td>
              <a href="{% url 'request_detail' req.pk %}" class="btn btn-outline-primary btn-sm d-flex align-items-center justify-content-center">
                <i class="fas fa-info-circle me-1 small"></i>
              </a>
            </td>
          </tr>


          {% if item.latest_status and item.latest_status.remarks %}
          <div class="modal fade" id="remarksModal{{ req.id }}" tabindex="-1" aria-labelledby="remarksModalLabel{{ req.id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content rounded-4">
                <div class="modal-header bg-danger text-white rounded-top-4">
                  <h6 class="modal-title" id="remarksModalLabel{{ req.id }}">
                    <i class="fas fa-info-circle me-1"></i>Disapproval Details
                  </h6>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <p><strong>Processed by:</strong> {{ item.latest_status.processed_by|default:item.latest_status.updated_by }}</p>
                  <p><strong>Comments:</strong></p>
                  <div class="border rounded p-2 bg-light">
                    {{ item.latest_status.remarks }}
                  </div>
                  {% if item.rejection_file %}
                  <hr>
                  <a href="{{ item.rejection_file }}" class="btn btn-sm btn-outline-primary mt-2">
                    <i class="fas fa-file-download me-1"></i>Download Attachment
                  </a>
                  {% elif item.latest_status.attachment %}
                  <hr>
                  <a href="{{ item.latest_status.attachment.url }}" class="btn btn-sm btn-outline-primary mt-2">
                    <i class="fas fa-file-download me-1"></i>Download Attachment
                  </a>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          {% endif %}
          {% endwith %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% else %}
<div class="alert alert-info text-center shadow-sm w-75 mx-auto mb-5 rounded-4">
  <i class="fas fa-info-circle me-2"></i>You haven’t made any transcript requests yet.
</div>
{% endif %}

  <div class="card border-0 shadow-lg rounded-4 mb-4">
    <div class="card-body text-center">
      <h5 class="fw-bold text-primary mb-4">Quick Actions</h5>
      <div class="row g-3 justify-content-center">
  <div class="row justify-content-center text-center my-4">
  <div class="col-md-5 mb-3">
    <a href="{% url 'request_transcript' %}" class="btn w-100">
      <i class="fas fa-plus-circle me-1"></i> Request New Transcript
    </a>
  </div>

  <div class="col-md-5 mb-3">
    <a href="{% url 'student_approved_transcripts' %}" class="btn w-100">
      <i class="fas fa-file-download me-1"></i> View Approved Transcripts
    </a>
  </div>
</div>
<style>
  /* From Uiverse.io by SujitAdroja – modified for your theme */
.btn {
  display: inline-block;
  text-align: center;
  color: black;
  text-transform: uppercase;
  text-decoration: none;
  border: 2px solid black;
  padding: 12px 20px;
  font-size: 15px;
  font-weight: bold;
  background: transparent;
  position: relative;
  transition: all 0.8s ease;
  overflow: hidden;
  border-radius: 6px;
}

.btn i {
  margin-right: 6px;
}

.btn:hover {
  color: red;
  border-color: black;
}

.btn::before {
  content: "";
  position: absolute;
  height: 100%;
  width: 0%;
  top: 0;
  left: -40px;
  transform: skewX(45deg);
  background-color: black;
  z-index: -1;
  transition: all 0.8s ease;
}

.btn:hover::before {
  width: 160%;
}

</style>
      </div>
    </div>
  </div>


</div>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<!-- 🌟 Floating WhatsApp Button -->
<div id="whatsapp-fab">
  <button id="whatsapp-btn" class="whatsapp-btn" data-bs-toggle="modal" data-bs-target="#whatsappModal">
    <i class="fab fa-whatsapp"></i>
  </button>
</div>

<!-- 🌟 WhatsApp Modal -->
<div class="modal fade" id="whatsappModal" tabindex="-1" aria-labelledby="whatsappModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 rounded-4 shadow-lg overflow-hidden">

      <!-- HEADER -->
      <div class="modal-header text-white border-0" 
           style="background: linear-gradient(135deg, #20c997, #128C7E); border-top-left-radius: 20px; border-top-right-radius: 20px;">
        <h5 class="modal-title fw-bold d-flex align-items-center" id="whatsappModalLabel">
          <i class="fab fa-whatsapp me-2 fs-4 text-white"></i>
          Official WhatsApp Groups
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <!-- BODY -->
      <div class="modal-body bg-light">
        <p class="text-muted text-center mb-4">
          Connect, collaborate, and stay informed — join your community below:
        </p>

        <div class="row g-3 justify-content-center">

          <!-- Career & Internships -->
   {% for group in whatsapp_groups %}
<div class="col-12">
  <div class="group-card shadow-sm p-3 rounded-4 bg-white border-start border-success border-3">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div>
        <h6 class="fw-bold text-success mb-1">
          <i class="fas {{ group.icon }} me-2"></i>{{ group.name }}
        </h6>
        <p class="text-muted small mb-0">{{ group.description }}</p>
      </div>
      <a href="{{ group.link }}" target="_blank"
         class="btn btn-success btn-sm rounded-pill px-3 d-flex align-items-center shadow-sm">
         <i class="fab fa-whatsapp me-1"></i>Join
      </a>
    </div>
  </div>
</div>
{% endfor %}


        </div>
      </div>

      <!-- FOOTER -->
      <div class="modal-footer border-0 text-center bg-light rounded-bottom-4">
        <small class="text-muted w-100">Stay Connected • Engage • Grow Together 🌿</small>
      </div>

    </div>
  </div>
</div>

<!-- 🌟 Styles -->
<style>
/* Floating Button */
#whatsapp-fab {
  position: fixed;
  bottom: 30px;
  right: 30px;
  z-index: 1055;
}

.whatsapp-btn {
  background: linear-gradient(135deg, #25D366, #128C7E);
  color: white;
  border: none;
  border-radius: 50%;
  width: 65px;
  height: 65px;
  font-size: 30px;
  box-shadow: 0 10px 25px rgba(18, 140, 126, 0.4);
  transition: all 0.4s ease-in-out;
  animation: slowFloat 6s ease-in-out infinite;
}

/* Slow pulsing float animation */
@keyframes slowFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
}

.whatsapp-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 15px 30px rgba(18, 140, 126, 0.6);
}

/* Modal Styling */
.modal-content {
  border-radius: 20px;
  animation: fadeUp 0.5s ease;
}

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}

/* WhatsApp Group Cards */
.group-card {
  transition: all 0.3s ease;
}
.group-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
}

/* Fix invisible button issue */
.group-card a.btn {
  opacity: 1 !important;
  visibility: visible !important;
}

/* Responsive */
@media (max-width: 576px) {
  .whatsapp-btn {
    width: 55px;
    height: 55px;
    font-size: 25px;
    bottom: 20px;
    right: 20px;
  }
}
</style>

<!-- FontAwesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

{% endblock %}
