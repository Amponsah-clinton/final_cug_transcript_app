{% extends 'base.html' %}
{% block content %}

<style>
  /* ===== Layout & Background ===== */
  body {
    background: linear-gradient(135deg, #f2f5fa, #e9eef7);
    font-family: 'Inter', 'Segoe UI', sans-serif;
  }

  .upload-wrapper {
    max-width: 800px;
    margin: 60px auto;
    padding: 0 20px;
  }

  .upload-card {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.06);
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .upload-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
  }

  .upload-header {
    background: linear-gradient(90deg, #002e6e, #0056d6);
    color: white;
    padding: 1.2rem 1.5rem;
    font-weight: 600;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .upload-body {
    padding: 2rem;
  }

  h4 {
    margin-bottom: 0.75rem;
    font-size: 1.4rem;
    font-weight: 700;
    color: #1a1a1a;
  }

  p.desc {
    color: #6b7280;
    font-size: 0.95rem;
    margin-bottom: 1.8rem;
  }

  /* ===== Form Fields ===== */
  label {
    font-weight: 600;
    font-size: 0.9rem;
    color: #333;
    display: block;
    margin-bottom: 6px;
  }

  input[type="text"],
  select,
  textarea,
  input[type="file"] {
    width: 100%;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    font-size: 0.95rem;
    transition: all 0.2s ease;
  }

  input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: #0056d6;
    box-shadow: 0 0 0 3px rgba(0, 86, 214, 0.1);
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
  }

  textarea {
    min-height: 100px;
  }

  /* ===== Buttons ===== */
  .btn {
    padding: 0.7rem 1.4rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.25s ease;
    border: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }

  .btn-primary {
    background: linear-gradient(90deg, #0056d6, #0078ff);
    color: white;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 86, 214, 0.25);
  }

  .btn-secondary {
    background: #f3f4f6;
    color: #374151;
  }

  .btn-secondary:hover {
    background: #e5e7eb;
  }

  .btn-group {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 1.5rem;
  }

  /* ===== Student Search ===== */
  #studentResults {
    margin-top: 5px;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #e5e7eb;
    background: white;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  }

  #studentResults button {
    display: block;
    width: 100%;
    padding: 10px 12px;
    border: none;
    background: white;
    text-align: left;
    cursor: pointer;
    transition: 0.2s;
    font-size: 0.95rem;
  }

  #studentResults button:hover {
    background: #f3f4f6;
  }

  #chosenStudent {
    background: #f9fafc;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 0.75rem 1rem;
    margin-top: 0.8rem;
  }

  /* ===== Preview Box ===== */
  .preview-box {
    margin-top: 1.5rem;
    background: #f0f5ff;
    border-left: 4px solid #0056d6;
    border-radius: 10px;
    padding: 1rem;
  }

  .preview-box h6 {
    color: #0056d6;
    font-weight: 600;
    margin-bottom: 6px;
  }

  /* ===== Responsive ===== */
  @media (max-width: 600px) {
    .upload-body {
      padding: 1.5rem;
    }
    .upload-header {
      font-size: 1rem;
    }
  }

  .hidden { display: none !important; }
</style>

<div class="upload-wrapper">
  <div class="upload-card">
    <div class="upload-header">
      <i class="fas fa-upload"></i>
      Exams Office Manual Upload
    </div>

    <div class="upload-body">
      <h4>Manual Transcript Upload</h4>
      <p class="desc">Upload a transcript manually. It will be forwarded to the Registrar for review and final approval.</p>

      <form method="post" enctype="multipart/form-data" id="examsOfficeUploadForm">
        {% csrf_token %}

        <label>Search Student (name or index)</label>
        <input type="text" id="studentSearch" placeholder="Type name or index..." autocomplete="off">
        <div id="studentResults"></div>
        <input type="hidden" name="student_index" id="studentIndexField">

        <div id="chosenStudent" class="hidden">
          <strong id="chosenName"></strong><br>
          <small>Index: <span id="chosenIndex"></span></small>
        </div>

        <div class="form-grid" style="margin-top:1.2rem;">
          <div class="form-col">
            <label>Transcript Type</label>
            {{ form.transcript_type }}
          </div>
          <div class="form-col" id="facultyContainer">
            <label>Faculty Registrar (Unofficial)</label>
            {{ form.faculty_registrar }}
          </div>
        </div>

        <div style="margin-top:1rem;">
          <label>Upload PDF</label>
          {{ form.transcript_file }}
        </div>

        <div style="margin-top:1rem;">
          <label>Remarks for Registrar</label>
          {{ form.remarks }}
        </div>

        <div class="btn-group">
          <a href="{% url 'staff_dashboard' %}" class="btn btn-secondary">Cancel</a>
          <button class="btn btn-primary" id="submitBtn">
            <i class="fas fa-paper-plane"></i> Upload & Forward
          </button>
        </div>

        <div id="previewSection" class="preview-box hidden">
          <h6><i class="fas fa-eye"></i> Preview Transcript</h6>
          <p>After uploading, you can preview the generated transcript below:</p>
          <a href="#" id="previewLink" target="_blank" class="btn btn-primary btn-sm">
            <i class="fas fa-eye"></i> View Preview
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const search = document.getElementById('studentSearch');
  const resBox = document.getElementById('studentResults');
  const idxField = document.getElementById('studentIndexField');
  const chosen = document.getElementById('chosenStudent');
  const chosenName = document.getElementById('chosenName');
  const chosenIndex = document.getElementById('chosenIndex');
  const facultyContainer = document.getElementById('facultyContainer');

  let timer = null;
  search.addEventListener('input', function(){
    const q = this.value.trim();
    idxField.value = '';
    chosen.classList.add('hidden');
    if(timer) clearTimeout(timer);
    if(q.length < 2){ resBox.innerHTML = ''; return; }
    timer = setTimeout(()=>{
      fetch('{% url "ajax_student_search" %}?q=' + encodeURIComponent(q))
        .then(r=>r.json())
        .then(data=>{
          resBox.innerHTML = '';
          (data.results||[]).forEach(s=>{
            const a = document.createElement('button');
            a.type = 'button';
            a.className = 'student-result-item';
            a.textContent = s.name + ' â€” ' + s.index_number;
            a.dataset.index = s.index_number;
            a.dataset.name = s.name;
            a.addEventListener('click', function(){
              idxField.value = this.dataset.index;
              chosenName.textContent = this.dataset.name;
              chosenIndex.textContent = this.dataset.index;
              chosen.classList.remove('hidden');
              resBox.innerHTML = '';
              search.value = `${this.dataset.name} (${this.dataset.index})`;
            });
            resBox.appendChild(a);
          });
        }).catch(()=>{ resBox.innerHTML = ''; });
    }, 250);
  });

  // Hide faculty when official selected
  const typeSel = document.querySelector('select[name="transcript_type"]');
  const facultySel = document.querySelector('select[name="faculty_registrar"]');
  function toggleFaculty(){
    if(typeSel && facultyContainer){
      if(typeSel.value === 'unofficial'){
        facultyContainer.style.display = '';
      } else {
        facultyContainer.style.display = 'none';
      }
    }
  }
  toggleFaculty();
  if(typeSel) typeSel.addEventListener('change', toggleFaculty);
});
</script>

{% endblock %}
