{% extends 'base.html' %}
{% block title %}Generate Transcript{% endblock %}
{% block content %}
<style>
  body {
    background-color: #f4f6f8;
    font-family: "Inter", "Segoe UI", sans-serif;
  }

  .card {
    background: #ffffff;
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
    padding: 35px;
    margin: 50px auto;
    max-width: 800px;
    border: 1px solid #e1e5eb;
  }

  h4 {
    color: #1b3358;
    font-weight: 700;
    text-align: center;
    margin-bottom: 25px;
  }

  p {
    color: #555;
  }

  .form-label {
    color: #1b3358;
    font-weight: 600;
  }

  .form-select, .form-control {
    border-radius: 8px;
    border: 1px solid #cfd6dd;
    padding: 10px;
    font-size: 15px;
  }

  .form-select:focus, .form-control:focus {
    border-color: #1b3358;
    box-shadow: 0 0 5px rgba(27, 51, 88, 0.3);
    outline: none;
  }

  .alert {
    border-radius: 10px;
    padding: 14px 18px;
    margin-bottom: 20px;
    font-size: 15px;
  }

  .alert-info {
    background-color: #f0f5ff;
    border-left: 5px solid #1b3358;
    color: #1b3358;
  }

  .alert-success {
    background-color: #edf9f0;
    border-left: 5px solid #3e8e41;
    color: #235d26;
  }

  /* Modern button style with subtle hover animation */
  .btn {
    position: relative;
    overflow: hidden;
    padding: 10px 22px;
    font-weight: 600;
    font-size: 15px;
    border: 2px solid #1b3358;
    background: #ffffff;
    color: #1b3358;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.4s ease;
    text-transform: uppercase;
  }

  .btn:hover {
    color: white;
    background: #1b3358;
    transform: translateY(-1px);
  }

  .btn-outline-secondary {
    border-color: #6c757d;
    color: #6c757d;
  }

  .btn-outline-secondary:hover {
    background-color: #6c757d;
    color: white;
  }

  .btn[disabled] {
    opacity: 0.65;
    cursor: not-allowed;
  }

  .d-flex {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  @media (max-width: 768px) {
    .card {
      margin: 20px;
      padding: 25px;
    }

    .btn {
      width: 100%;
      text-align: center;
    }

    .d-flex {
      flex-direction: column;
    }
  }
</style>

<div class="card">
  <h4>Generate Transcript for {{ transcript_request.reference_code }}</h4>

  <div class="mb-4 p-3 border rounded" style="background-color: #f9fafc;">
    <h5 class="fw-bold text-primary mb-3">Student Information</h5>
    <div class="row g-2">
      <div class="col-md-6">
        <p><strong>Name:</strong> {{ student.name }}</p>
        <p><strong>Index Number:</strong> {{ student.index_number }}</p>
        <p><strong>Program:</strong> {{ student.program }}</p>
      </div>
      <div class="col-md-6">
        <p><strong>Department:</strong> {{ department }}</p>
        <p><strong>Transcript Type:</strong> {{ transcript_request.transcript_type|title }}</p>
      </div>
    </div>
  </div>

  <form method="post">
    {% csrf_token %}

    {% if transcript_request.transcript_type == 'official' %}
      <div class="alert alert-info">
        This is an <strong>Official Transcript</strong>. Registrar and Vice Chancellor signatures will be auto-included.
      </div>

      <div class="d-flex gap-2 mt-3">
        <a id="previewBtnOfficial" class="btn btn-outline-secondary" href="#" target="_blank">
          <i class="fas fa-eye me-1"></i>Preview
        </a>
        <a href="{% url 'exams_office_approve_disapprove' transcript_request.id %}" 
   class="btn btn-outline-primary">
  <i class="fas fa-folder-open me-1"></i> Disapprove
</a>
        <button type="submit" name="action" value="forward" class="btn btn-primary">
          <i class="fas fa-forward me-1"></i>Forward to Registrar
        </button>
      </div>

      <script>
        (function(){
          const preview = document.getElementById('previewBtnOfficial');
          preview.addEventListener('click', function(e){
            e.preventDefault();
            let url = "{% url 'generate_transcript_preview' transcript_request.id %}";
            window.open(url, '_blank');
          });
        })();
      </script>

    {% else %}
      <div class="mb-3">
        <p>
          This is an <strong>Unofficial Transcript</strong>. Select the <strong>Faculty Registrar</strong> whose details will appear on the transcript,
          then <strong>forward to the Registrar for approval</strong>.
        </p>

        {% if already_forwarded %}
          <div class="alert alert-success">
            ✅ This unofficial transcript has already been forwarded to the Registrar. Registrar selection is locked.
          </div>
          <label class="form-label">Faculty Registrar</label>
          <select class="form-select mb-3" disabled>
            {% for reg in registrars %}
              <option {% if parsed_registrar_id and parsed_registrar_id == reg.id %}selected{% endif %}>
                {{ reg.name }} — {{ reg.faculty_name }}
              </option>
            {% endfor %}
          </select>
          <button type="button" class="btn btn-secondary" disabled>Already Forwarded</button>

        {% else %}
          <label class="form-label">Select Faculty Registrar (Required)</label>
          <select name="registrar_id" class="form-select mb-3" required>
            <option value="">-- Select Registrar --</option>
            {% for reg in registrars %}
              <option value="{{ reg.id }}" {% if parsed_registrar_id and parsed_registrar_id == reg.id %}selected{% endif %}>
                {{ reg.name }} — {{ reg.faculty_name }}
              </option>
            {% endfor %}
          </select>

          <div class="d-flex gap-2">
            <a id="previewBtn" class="btn btn-outline-secondary" href="#" target="_blank">
              <i class="fas fa-eye me-1"></i>Preview
            </a>
            <a href="{% url 'exams_office_approve_disapprove' transcript_request.id %}" 
   class="btn btn-outline-primary">
  <i class="fas fa-folder-open me-1"></i>Disapprove
</a>
            <button type="submit" name="action" value="forward_unofficial" class="btn btn-primary">
              <i class="fas fa-forward me-1"></i>Forward to Registrar for Approval
            </button>
          </div>

          <script>
            (function(){
              const preview = document.getElementById('previewBtn');
              const select = document.querySelector('select[name="registrar_id"]');
              
              function updatePreviewButton() {
                if (select && !select.value) {
                  preview.style.opacity = '0.6';
                  preview.title = 'Please select a Faculty Registrar first';
                } else {
                  preview.style.opacity = '1';
                  preview.title = 'Preview transcript';
                }
              }

              updatePreviewButton();

              if (select) {
                select.addEventListener('change', updatePreviewButton);
              }

              preview.addEventListener('click', function(e){
                e.preventDefault();
                const reg = select ? select.value : '';
                
                if (!reg) {
                  alert('Please select a Faculty Registrar first before previewing.');
                  if (select) select.focus();
                  return;
                }

                let url = "{% url 'generate_transcript_preview' transcript_request.id %}";
                if(reg){ url += '?registrar_id=' + encodeURIComponent(reg); }
                window.open(url, '_blank');
              });
            })();
          </script>
        {% endif %}
      </div>
    {% endif %}

    <!-- ✅ Exams Office Approval Section -->
    {% if user.is_staff and staff.role == 'exams_office' %}
      <hr class="my-4">
      <div class="mb-3">
        <h5 class="fw-bold text-primary mb-3">Exams Office Actions</h5>
        <p>You can approve or disapprove this transcript request.</p>

        <div class="mb-3">
          <label for="remarks" class="form-label fw-semibold">Remarks (optional)</label>
          <textarea name="remarks" id="remarks" class="form-control" rows="3" placeholder="Add any remarks..."></textarea>
        </div>

        <div class="d-flex gap-2">
          <button type="submit" name="action" value="approve" class="btn btn-success">
            <i class="fas fa-check me-1"></i> Approve
          </button>
          <button type="submit" name="action" value="disapprove" class="btn btn-danger">
            <i class="fas fa-times me-1"></i> Disapprove
          </button>
        </div>
      </div>
    {% endif %}

  </form>
</div>

{% endblock %}
